# Istio Add-On Module release v4.0.0

Welcome to the latest release of `Istio` module of [`SIGHUP Distribution`](https://github.com/sighupio/distribution) maintained by team SIGHUP.

This is a major release that:

- Adds support for Kubernetes 1.31 and 1.32
- Updates Istio to version 1.25.2
  - `BREAKING CHANGE`: removes Istio Operator support (deprecated upstream); now using direct manifest installation approach
- Introduces a new profile-based installation structure
- Reorganizes the code structure
- Updates Kiali to version 2.9.0
- Updates Jaeger to version 1.65.0

## Included packages

| Package         | Current Version                                                           | Previous Version |
| --------------  | ------------------------------------------------------------------------- | ---------------- |
| `istio-opertor` |     `Deprecated`        |  [`v1.23.3`](https://github.com/istio/istio/releases/tag/1.23.3)   |
| `istio`         | [`v1.25.2`](https://github.com/istio/istio/releases/tag/1.25.2)           | `New package`    |
| `kiali`         | [`v2.9.0`](https://github.com/kiali/kiali/releases/tag/v2.9.0)            | `v2.0.0`         |
| `jaeger`        | [`v1.65.0`](https://github.com/jaegertracing/jaeger/releases/tag/v1.65.0) | `v1.62.0`        |


## Upgrade Guide 🦮

### Upgrade Module version

1. Update the version in your `Furyfile.yaml` file:

```yaml
versions:
  service-mesh: v4.0.0

bases:
  - name: service-mesh
```

2. Download the module:

```bash
furyctl legacy vendor -H
```

### Upgrade Procedure Istio and Jaeger

⚠️ This Istio release includes a breaking change, this will cause downtime while performing the upgrade

#### Prerequisites

| Tool                                    | Version    |
| --------------------------------------- | ---------- |
| [istioctl][istioctl-repo]               | `=1.25.2`  |
| [yq][yq-repo]                           | `=v4.45.1` |

1. Choose your preferred profile and align your patches (if you have any)


  * 1.1 If you are coming from a previous IstioOperator Installation, mind this follow steps:

    Before going futher the steps of removing the Operator, you have to generate the manifests containing  the istio ConfigMap and all resources (Deployments, Services, HPAs, PDBs, RBAC, ServiceAccounts, etc.) for your custom ingress and egress gateways.

    

    Place the script `docs/migration/istioOperator-to-istio/export_istio_resources.sh` into your repository root, with your Istio Operator manifest file and rename it to `gateways.yaml`. Run the script to generate the following directory structure:

    ```
    gateway-split/
    ├── configmap/
    │   └── istio.yaml
    ├── ingress-gateway/
    │   └── ingress-gateway-resources.yaml
    └── egress-gateway/
        └── egress-gateway-resources.yaml
    ```
    * **configmap/istio.yaml**: the full data.mesh block from the Istio ConfigMap

    * **ingress-gateway/ingress-gateway-resources.yaml**: all Deployment, Service, HPA, PDB, RBAC, ServiceAccount, etc. for the ingress gateway

    * **egress-gateway/egress-gateway-resources.yaml**: same for the egress gateway

    Now you can import these folders into Kustomize as described in the next step.

  * 1.2 How to use in Kustomize

    In your distribution project the kustomize file: `plugin/kustomize/istio/kustomization.yaml`, should be compiled like this:

    ```yaml
    resources:
      - profiles/sidecar/base #(or other overlays)

      # Then import the extracted gateway resources:
      - gateway-split/configmap
      - gateway-split/ingress-gateway
      - gateway-split/egress-gateway
    ```
    In this example we brought:

    * The sidecar profile pulls CRDs, the default profile, and the generic gateway.

    * The `gateway-split/configmap` directory overrides just the ConfigMap/istio for apply previous `meshConfigs`.

    * The `gateway-split/ingress-gateway` and `gateway-split/egress-gateway` directories supply the Deployments, HPAs, PodDisruptionBudgets, RBAC, ServiceAccounts, and other resources **you need** to patch correctly your istio add-on.

2. Delete the operator resources:

```shell
kubectl -n istio-operator delete deployment istio-operator
kubectl delete customresourcedefinitions istiooperators.install.istio.io
kubectl -n istio-system patch istiooperators.install.istio.io istio -p '{"metadata":{"finalizers":[]}}' --type=merge
```
3. Analyze the differences against your environment:

```shell
cd examples/istio/
kustomize build . | kubectl diff -f - > diff.diff
```
4. Finally, apply the new manifests, e.g.:

```shell
cd examples/istio-base/
kustomize build . | kubectl apply -f -
```
5. Delete old istio-operator resources (from istio-operator namespace):

```shell
kubectl -n istio-operator delete deployment istio-operator
kubectl -n istio-operator delete serviceaccount istio-operator
kubectl -n istio-operator delete service istio-operator
kubectl delete clusterrole istio-operator
kubectl delete clusterrolebinding istio-operator
kubectl delete namespace istio-operator
```



<!-- links -->
[istioctl-repo]: https://istio.io/latest/docs/ops/diagnostic-tools/istioctl/#install-hahahugoshortcode971s2hbhb
[yq-repo]: https://github.com/mikefarah/yq