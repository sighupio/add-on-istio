# Using a custom intermediate CA with Citadel

## Background

Imagine you work for a big company that runs its own PKI. Most of these companies manage their own Root CA and generate
intermediate CAs to sign Clients and/or Server Certificates.

As Istio is capable of issuing certificates for every workload inside a mesh, it is possible to provide a custom CA
to sign the workload's certificates instead of using the self-signed one.


## Requirements

Ensure to have the following files:

- `certs/ca-cert.pem`: Certificate of the Intermediate CA.
- `certs/ca-key.pem`: Private key of the Intermediate CA.
- `certs/root-cert.pem`: Certificate of the Root CA.
- `certs/cert-chain.pem`: Certificate Chain. `cat certs/ca-cert.pem certs/root-cert.pem > certs/cert-chain.pem`.

Also, it's required to know what `katalog/istio/sidecar-injection/configuration` was used as some tuning will be
needed.

### Hands on

#### Istio Sidecar Configuration

Look into the `kustomization.yaml` file. It has to be defined a `service-mesh/istio/sidecar-injection/configuration/*`
istio configuration base.

*Example Istio `kustomization.yaml` file:*

```yaml
bases:
  - ../vendor/katalog/service-mesh/istio/minimal
  - ../vendor/katalog/service-mesh/istio/telemetry
  - ../vendor/katalog/service-mesh/istio/citadel
  - ../vendor/katalog/service-mesh/istio/egress-gateway
  - ../vendor/katalog/service-mesh/istio/sidecar-injection
  - ../vendor/katalog/service-mesh/istio/sidecar-injection/configuration/sidecar-injection-and-egress
```

This installation uses `sidecar-injection-and-egress` istio configuration file.
Override the `selfSigned` attribute's value from `true` to `false` a save it to the new kustomize project:

```bash
$ sed 's/"selfSigned": true,/"selfSigned": false/g' \
    ../vendor/katalog/service-mesh/istio/sidecar-injection/configuration/sidecar-injection-and-egress/patch.yaml > patches/istio-sidecar-injector.yaml
```

#### Kustomize!

Ensure to have the following files configured:

```bash
$ tree
.
├── certs
│   ├── ca-cert.pem
│   ├── ca-key.pem
│   ├── cert-chain.pem
│   └── root-cert.pem
├── kustomization.yaml
└── patches
    ├── istio-citadel.yaml
    └── istio-sidecar-injector.yaml

2 directories, 7 files
```

Run kustomize build to check everything is well configured:

```bash
$ kustomize build .
```

What kustomize does is to override the default citadel deployment:

- Creates a new Kubernetes secret named `cacerts` with the content of every file inside the `certs` directory.
- Adds it as `Volume` in the `istio-citadel` deployment.
- Mounts it in `/etc/cacerts` in the `citadel` container in the `istio-citadel` deployment.
- Modifies the `citadel` container command arguments to point to the new `ca` configuration.
- Replace `istio-sidecar-injector` configmap with the modified version *(marked `selfSigned: false`)*.

Apply it

```bash
$ kustomize build . | kubectl apply -f - -n istio-system
```

### Test it

To make sure the workloads obtain the new certificates promptly, delete the secrets generated by Citadel
*(named as istio.\*)*. In this example, istio.default. Citadel will issue new certificates for the workloads.

```bash
$ kubectl delete secret istio.default
```

## Links

- https://istio.io/docs/tasks/security/citadel-config/plugin-ca-cert/
- https://jamielinux.com/docs/openssl-certificate-authority/create-the-root-pair.html

